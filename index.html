<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Auto Composite (10×8, 4×5 Tiles)</title>
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<style>
  :root{
    --bg:#0b1020; --panel:#111729; --ink:#e6edf3; --muted:#9aa4b2; --accent:#0ea5e9; --border:#22304a;
    --radius:14px; --shadow:0 6px 18px rgba(0,0,0,.25);
  }
  *{box-sizing:border-box}
  body{
    margin:0; font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,Helvetica,sans-serif;
    background:linear-gradient(180deg,#0b1020 0%,#0c172f 100%); color:var(--ink);
  }
  header{padding:24px; text-align:center}
  header h1{margin:.2rem 0 0; font-size:1.4rem; font-weight:700; letter-spacing:.2px}
  header p{margin:.3rem 0 0; color:var(--muted); font-size:.95rem}

  .wrap{max-width:1100px; margin:0 auto; padding:16px 20px 64px}
  .grid{display:grid; grid-template-columns: 1.2fr .8fr; gap:16px}
  @media (max-width: 980px){ .grid{grid-template-columns:1fr; } }

  .card{
    background:rgba(9,14,28,.6); backdrop-filter: blur(10px);
    border:1px solid var(--border); border-radius:var(--radius); box-shadow:var(--shadow);
  }
  .card h2{font-size:1rem; font-weight:700; margin:0; padding:16px 16px 0}
  .card .body{padding:16px}

  .drop{
    border:2px dashed #2a3b61; border-radius:12px; padding:18px; text-align:center; color:var(--muted);
    transition:.2s border-color,.2s background;
  }
  .drop.drag{border-color:var(--accent); background:rgba(14,165,233,.08); color:var(--ink)}
  .drop input{display:none}
  .thumbs{display:grid; grid-template-columns:repeat(auto-fill,minmax(120px,1fr)); gap:12px; margin-top:12px}
  .thumb{
    border:1px solid var(--border); border-radius:10px; overflow:hidden; background:#0e1425;
    aspect-ratio: 4/5; display:flex; align-items:center; justify-content:center;
  }
  .thumb img{width:100%; height:100%; object-fit:cover}

  .controls{display:grid; grid-template-columns:repeat(2,1fr); gap:10px}
  .controls .row{display:flex; gap:10px}
  .controls label{display:block; font-size:.85rem; color:var(--muted); margin-bottom:6px}
  .controls input[type="number"], .controls input[type="text"], .controls select, .controls input[type="color"]{
    width:100%; padding:10px 12px; border:1px solid var(--border); border-radius:10px; background:#0d1528; color:var(--ink);
  }
  .controls .help{font-size:.8rem; color:var(--muted); margin-top:4px}

  .btns{display:flex; flex-wrap:wrap; gap:10px; margin-top:12px}
  button,.btn{
    appearance:none; border:1px solid #254060; background:#102036; color:#dce7f5;
    padding:10px 14px; border-radius:10px; cursor:pointer; font-weight:600;
  }
  button.primary{background:var(--accent); border-color:#0ea5e9; color:#00121a}
  button:disabled{opacity:.6; cursor:not-allowed}

  #output{padding:16px; display:grid; gap:16px}
  canvas{width:100%; height:auto; image-rendering:crisp-edges; background:#fff; border-radius:8px}
  .dl{display:flex; gap:10px; flex-wrap:wrap}
  .small{font-size:.85rem; color:var(--muted)}
</style>
</head>
<body>
<header>
  <h1>Automated Composite Builder</h1>
  <p>Tiles forced to <strong>4×5</strong>. Composite size <strong>10×8 in</strong> (default), rendered at <strong>300 DPI</strong> = 3000×2400 px.</p>
</header>

<div class="wrap">
  <div class="grid">

    <!-- Left: input & thumbs -->
    <section class="card">
      <h2>Upload Images</h2>
      <div class="body">
        <div id="drop" class="drop">
          <strong>Drag & drop</strong> headshots here or
          <label for="filePick" class="btn">Browse</label>
          <input id="filePick" type="file" accept="image/*" multiple>
          <div class="small" style="margin-top:8px">Tip: Upload portraits. Cropping will center-crop to 4:5.</div>
        </div>
        <div id="thumbs" class="thumbs" aria-live="polite"></div>
      </div>
    </section>

    <!-- Right: settings -->
    <section class="card">
      <h2>Layout & Export</h2>
      <div class="body">
        <div class="controls">
          <div>
            <label>Preset Size</label>
            <select id="preset">
              <option value="3000x2400">10×8 in @ 300 DPI (3000×2400)</option>
              <option value="2400x3000">8×10 in @ 300 DPI (2400×3000)</option>
              <option value="4500x3600">15×12 in @ 300 DPI (4500×3600)</option>
              <option value="6000x4800">20×16 in @ 300 DPI (6000×4800)</option>
            </select>
          </div>
          <div class="row">
            <div>
              <label>Canvas W (px)</label>
              <input id="cw" type="number" value="3000" min="800">
            </div>
            <div>
              <label>Canvas H (px)</label>
              <input id="ch" type="number" value="2400" min="800">
            </div>
          </div>

          <div class="row">
            <div>
              <label>Columns <span class="small">(leave 0 for Auto)</span></label>
              <input id="cols" type="number" value="0" min="0" step="1">
              <div class="help">Auto maximizes tile size while fitting all rows.</div>
            </div>
            <div>
              <label>Margin (px)</label>
              <input id="margin" type="number" value="80" min="0">
            </div>
          </div>

          <div class="row">
            <div>
              <label>Gutter (px)</label>
              <input id="gutter" type="number" value="24" min="0">
            </div>
            <div>
              <label>Background</label>
              <input id="bg" type="color" value="#ffffff" />
            </div>
          </div>

          <div class="row">
            <div>
              <label>Title (optional)</label>
              <input id="title" type="text" placeholder="e.g., Lincoln Elementary • Grade 3 • 2025–26">
            </div>
            <div>
              <label>Title Size (px)</label>
              <input id="titleSize" type="number" value="72" min="20" step="2">
            </div>
          </div>
        </div>

        <div class="btns">
          <button id="btnGen" class="primary" disabled>Generate Composite</button>
          <button id="btnClear">Clear</button>
        </div>
        <div class="small" style="margin-top:8px">
          Output is exact pixel size. For 10×8″ prints at 300 DPI, use 3000×2400 px.
        </div>
      </div>
    </section>

  </div>

  <section class="card" style="margin-top:16px">
    <h2>Output</h2>
    <div class="body">
      <div id="output"></div>
      <div class="btns dl" id="downloads"></div>
    </div>
  </section>
</div>

<script>
(() => {
  const drop = document.getElementById('drop');
  const filePick = document.getElementById('filePick');
  const thumbs = document.getElementById('thumbs');
  const btnGen = document.getElementById('btnGen');
  const btnClear = document.getElementById('btnClear');
  const output = document.getElementById('output');
  const downloads = document.getElementById('downloads');

  const preset = document.getElementById('preset');
  const cw = document.getElementById('cw');
  const ch = document.getElementById('ch');
  const colsEl = document.getElementById('cols');
  const marginEl = document.getElementById('margin');
  const gutterEl = document.getElementById('gutter');
  const bgEl = document.getElementById('bg');
  const titleEl = document.getElementById('title');
  const titleSizeEl = document.getElementById('titleSize');

  let images = []; // {img:HTMLImageElement, w, h, url}

  function setPreset() {
    const [w,h] = preset.value.split('x').map(n=>parseInt(n,10));
    cw.value = w; ch.value = h;
  }
  preset.addEventListener('change', setPreset);

  // Drag & drop
  ['dragenter','dragover'].forEach(ev=>{
    drop.addEventListener(ev, e => { e.preventDefault(); e.stopPropagation(); drop.classList.add('drag'); });
  });
  ;['dragleave','drop'].forEach(ev=>{
    drop.addEventListener(ev, e => { e.preventDefault(); e.stopPropagation(); drop.classList.remove('drag'); });
  });
  drop.addEventListener('drop', e => handleFiles(e.dataTransfer.files));
  drop.addEventListener('click', () => filePick.click());
  filePick.addEventListener('change', e => handleFiles(e.target.files));

  function handleFiles(fileList){
    const files = Array.from(fileList).filter(f => f.type.startsWith('image/'));
    if(!files.length) return;
    Promise.all(files.map(loadImage))
      .then(loaded => {
        images.push(...loaded);
        refreshThumbs();
        btnGen.disabled = images.length === 0;
      })
      .catch(console.error);
  }

  function loadImage(file){
    return new Promise((resolve,reject)=>{
      const url = URL.createObjectURL(file);
      const img = new Image();
      // Let browser respect EXIF orientation if supported:
      if ('decode' in img) { /* modern browsers */ }
      img.onload = () => resolve({img, w: img.naturalWidth, h: img.naturalHeight, url});
      img.onerror = reject;
      img.src = url;
    });
  }

  function refreshThumbs(){
    thumbs.innerHTML = '';
    images.forEach((o,i)=>{
      const d = document.createElement('div');
      d.className = 'thumb';
      const im = document.createElement('img');
      im.src = o.url;
      d.title = `Image ${i+1}`;
      d.appendChild(im);
      thumbs.appendChild(d);
    });
  }

  btnClear.addEventListener('click', ()=>{
    images.forEach(o=>URL.revokeObjectURL(o.url));
    images = [];
    thumbs.innerHTML = '';
    output.innerHTML = '';
    downloads.innerHTML = '';
    btnGen.disabled = true;
  });

  // Core layout
  btnGen.addEventListener('click', ()=>{
    output.innerHTML = '';
    downloads.innerHTML = '';
    const W = Math.max(1, parseInt(cw.value,10));
    const H = Math.max(1, parseInt(ch.value,10));
    const M = Math.max(0, parseInt(marginEl.value,10));
    const G = Math.max(0, parseInt(gutterEl.value,10));
    const bg = bgEl.value || '#ffffff';
    const wantedCols = Math.max(0, parseInt(colsEl.value,10));
    const titleText = (titleEl.value||'').trim();
    const titleSize = Math.max(10, parseInt(titleSizeEl.value,10));

    // Reserve title area if present
    const titlePad = titleText ? Math.ceil(titleSize * 1.6) : 0;

    // Compute content box
    const contentX = M, contentY = M + titlePad;
    const contentW = W - 2*M;
    const contentH = H - 2*M - titlePad;
    if (contentW <= 0 || contentH <= 0) {
      alert('Canvas too small for chosen margins/title. Reduce Margin or Title Size.');
      return;
    }

    // Pagination logic: pack images across multiple pages
    const pages = paginateTiles(images.length, wantedCols, contentW, contentH, G);

    if (pages.tilesPerPage === 0) {
      alert('Settings produce zero tiles per page (try fewer columns, smaller margins, or larger canvas).');
      return;
    }

    // Build canvases
    const pageCount = pages.pageCount;
    const placements = pages.pagePlacements; // array of pages → array of {x,y,w,h,index}

    for(let p=0; p<pageCount; p++){
      const c = document.createElement('canvas');
      c.width = W; c.height = H;
      const ctx = c.getContext('2d');

      // Background
      ctx.save();
      ctx.fillStyle = bg;
      ctx.fillRect(0,0,W,H);
      ctx.restore();

      // Title
      if (titleText){
        ctx.save();
        ctx.fillStyle = '#000000';
        // Auto-pick black/white based on bg luminance
        const lum = luminanceFromHex(bg);
        ctx.fillStyle = lum > 0.55 ? '#111111' : '#ffffff';
        ctx.font = `700 ${titleSize}px Inter, Arial, sans-serif`;
        ctx.textAlign = 'center';
        ctx.textBaseline = 'top';
        ctx.fillText(titleText, W/2, M);
        ctx.restore();
      }

      // Draw tiles
      const cells = placements[p];
      for (const cell of cells){
        const imgObj = images[cell.index];
        if(!imgObj) continue;
        drawCropped4x5(ctx, imgObj.img, contentX + cell.x, contentY + cell.y, cell.w, cell.h);
      }

      // Add to DOM + download link
      output.appendChild(c);
      const a = document.createElement('a');
      a.className = 'btn';
      a.download = pageCount > 1 ? `composite_${p+1}of${pageCount}.png` : 'composite.png';
      a.textContent = `Download ${a.download}`;
      a.href = c.toDataURL('image/png');
      downloads.appendChild(a);
    }
  });

  // Helpers

  // Pack images into pages with a fixed 4:5 tile ratio, choosing columns if "auto".
  function paginateTiles(count, wantedCols, contentW, contentH, G){
    const tileRatio = 4/5; // width:height
    // Choose columns
    const chooseCols = () => {
      if (wantedCols > 0) return wantedCols;
      // Try 1..12 columns; pick the one that yields the largest tile area AND fits >=1 row
      let best = 1, bestArea = 0;
      for (let c=1; c<=12; c++){
        const colW = (contentW - G*(c-1)) / c;
        const colH = colW / tileRatio; // since w:h = 4:5, h = w / (4/5) = w*5/4
        const rows = Math.floor((contentH + G) / (colH + G));
        if (rows < 1) continue;
        const perPage = c * rows;
        const area = Math.min(perPage, count) * (colW*colH);
        if (area > bestArea){ bestArea = area; best = c; }
      }
      return best;
    };

    const C = Math.max(1, chooseCols());
    // Given columns, compute exact tile size to fit rows maximally
    const colW_nominal = (contentW - G*(C-1)) / C;
    let colW = colW_nominal;
    let colH = colW / tileRatio;
    let rows = Math.floor((contentH + G) / (colH + G));

    if (rows < 1){
      // If nothing fits, shrink width until at least one row fits
      rows = 1;
      colH = contentH - (rows-1)*G; // rows==1 ⇒ full height
      colW = colH * tileRatio;
      // And reduce columns if needed to fit width
      let maxCols = Math.floor((contentW + G) / (colW + G));
      if (maxCols < 1) maxCols = 1;
      // Recompute with reduced columns
      if (wantedCols === 0 && maxCols < C){
        // try again with maxCols
        colW = (contentW - G*(maxCols-1)) / maxCols;
        colH = colW / tileRatio;
        rows = Math.floor((contentH + G) / (colH + G));
        // guard
        if (rows < 1) rows = 1;
      }
    }

    const perPage = Math.max(1, C * rows);

    const pagePlacements = [];
    const pageCount = Math.ceil(count / perPage);

    for (let p=0; p<pageCount; p++){
      const start = p * perPage;
      const end = Math.min(count, start + perPage);
      const cells = [];
      for (let i=start; i<end; i++){
        const k = i - start; // index within page
        const r = Math.floor(k / C);
        const c = k % C;
        const x = c * (colW + G);
        const y = r * (colH + G);
        cells.push({x, y, w: colW, h: colH, index: i});
      }
      pagePlacements.push(cells);
    }

    return { pageCount, tilesPerPage: perPage, pagePlacements };
  }

  // Center-crop source image to 4:5 (width:height) then draw into dest rect
  function drawCropped4x5(ctx, img, dx, dy, dw, dh){
    const targetRatio = 4/5;
    const iw = img.naturalWidth || img.width;
    const ih = img.naturalHeight || img.height;
    const r = iw / ih;

    let sx, sy, sw, sh;
    if (r > targetRatio){
      // too wide → crop width
      sh = ih;
      sw = ih * targetRatio;
      sx = (iw - sw) / 2;
      sy = 0;
    } else {
      // too tall → crop height
      sw = iw;
      sh = iw / targetRatio;
      sx = 0;
      sy = (ih - sh) / 2;
    }
    ctx.drawImage(img, sx, sy, sw, sh, dx, dy, dw, dh);
  }

  function luminanceFromHex(hex){
    // hex like #rrggbb
    const c = hex.replace('#','');
    const r = parseInt(c.slice(0,2),16)/255;
    const g = parseInt(c.slice(2,4),16)/255;
    const b = parseInt(c.slice(4,6),16)/255;
    // sRGB → approx rel. luminance
    const lin = (u)=> (u<=0.03928? u/12.92 : Math.pow((u+0.055)/1.055,2.4));
    return 0.2126*lin(r) + 0.7152*lin(g) + 0.0722*lin(b);
  }
})();
</script>
</body>
</html>
